{% assign section_id = section.id | replace: "_", "" | replace: "-", "" %}
{% render "section-styles", section_id: section_id, section: section %}

<link href="{{ "main-product.css" | asset_url }}" rel="stylesheet">

{% assign current_variant = product.selected_or_first_available_variant %}

<div class="wrap wrap--xx-large wrap--{{section_id }} wrap--no-padding-mobile">

    {% render "breadcrumbs" %}

    <div class="section-product__product">

        {% render "product-media", product: product %}

        <div class="section-product__container">
            <div class="section-product__details">

                {% form 'product', product, class: "product-form" %}

                    <input type="hidden" name="properties[_MID_Name]" value="{{ product.metafields.mid_info.mid_name.value }}" />
                    <input type="hidden" name="properties[_MID_Code]" value="{{ product.metafields.mid_info.mid_code.value }}" />
                    <input type="hidden" name="properties[_MID_Address]" value="{{ product.metafields.mid_info.mid_address.value }}" />

                    {% if product.available %}
                    <div class="section-product__details__availability">
                        <span class="alert">
                            <span class="marker"><span></span></span>
                            <span class="label">{{ "products.product.in_stock" | t }}</span>
                        </span>
                    </div>
                    {% endif %}
                
                    <div class="section-product__details__title">
                        <h1>{{ product.title }}</h1>
                    </div>

                    {% assign product_colour = product.metafields.product.colour.value %}
                    {% if product_colour != blank %}
                    <div class="section-product__details__colour">
                        <span>{{ "products.product.colour" | t }} {{ product_colour }}</span>
                    </div>
                    {% endif %}

                    <div class="section-product__details__price">
                        {% render "product-price", product: product %}
                    </div>

                    <div class="section-product__details__variants">
                        <div class="section-product__details__variants__name">
                            <span class="variant-name">{{ "products.product.size" | t }}</span>
                            <span class="variant-warning hidden">{{ "products.product.select_size" | t }}</span>
                            {% assign has_size_guide = false %}
                            {% for object in shop.metaobjects['size_chart'].values %}
                                {% if object.product_type == product.type %}
                                    <button class="toggle-size-modal" aria-label="{{ "products.product.size_guide" | t }}">{{ "products.product.size_guide" | t }}</button>
                                    {% assign has_size_guide = true %}
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% render "product-variants", product: product %}
                    </div>

                    {% render "product-quantity" , product: product %}

                    <div class="section-product__details__actions">
                        {% if product.available %}
                        <button type="submit" name="add" class="button button--add-to-cart button--highlight button--full-width button--tall" aria-label="{{ 'products.product.add_to_cart' | t }}"><span>{{ 'products.product.add_to_cart' | t }}</span></button>
                        {% else %}
                        <button type="submit" name="add" class="button button--add-to-cart button--full-width" aria-label="{{ 'products.product.sold_out' | t }}" disabled>{{ 'products.product.sold_out' | t }}</button>
                        {% endif %}
                    </div>

                    <div class="section-product__details__messages">
                        {% for block in section.blocks %}
                            {% case block.type %}
                                {% when "country_text" %}
                                <div class="country-message hidden" data-code="{{ block.settings.code }}" data-condition="{{ block.settings.condition }}">
                                    {{ block.settings.title }}
                                </div>
                                {% when "continent_text" %}
                                <div class="continent-message hidden" data-code="{{ block.settings.code }}" data-condition="{{ block.settings.condition }}">
                                    {{ block.settings.title }}
                                </div>
                            {% endcase %}
                        {% endfor %}
                    </div>

                    <div class="section-product__details__klarna">
                        <!-- Placement v1 -->
                        <klarna-placement
                            data-id1="f4d06adf-37ef-4a99-b176-184905040ee0"
                            data-key="credit-promotion-badge"
                            data-locale="en-GB"
                            data-purchase_amount="{{ product.selected_or_first_available_variant.price }}"
                            data-theme="custom"
                        ></klarna-placement>
                        <!-- end Placement -->
                    </div>

                    <div class="section-product__details__accordions">
                        {% render "product-accordions", product: product, section: section %}
                    </div>

                    {% if product.metafields.product.complete_the_look.value != blank %}
                    <div class="section-product__details__look">
                        <div class="section-product__details__look__header">
                            <h4>{{ "product.product.complete_the_look" | t }}</h4>
                        </div>
                        <div class="section-product__details__look__products">
                        {% assign look_products = product.metafields.product.complete_the_look.value.look_products.value %}
                        {% assign current_product = product.id %}
                        {% for product in look_products %}
                            {% unless product.id == current_product %}
                            <a href="{{ product.url }}" aria-label="{{ product.title }}">
                                <img 
                                    {% if request.design_mode %}
                                    src="{{ product.featured_image.src | img_url: '200x270', crop: "center" }}" 
                                    {% else %}
                                    src="{{ "preload.gif" | asset_url }}" 
                                    data-src="{{ product.featured_image.src | img_url: '200x270', crop: "center" }}" 
                                    class="preload" 
                                    {% endif %}
                                    alt="{{ product.title }}" 
                                    width="200" 
                                    height="270" 
                                >
                            </a>
                            {% endunless %}
                        {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                {% endform %}

            </div>
            
        </div>

    </div>
    
</div>

{% if has_size_guide == true %}
    {% render "drawer-guides", object: object, current_product_type: product.type %}
{% endif %}

<script src="{{ "main-product.js" | asset_url }}"></script>

{% schema %}
{
    "name": "Product",
    "tag": "section",
    "class": "section-product",
    "blocks": [
        {
            "type": "country_text",
            "name": "Country Message",
            "settings": [
                {
                    "type": "header",
                    "content": "Display condition"
                },
                {
                    "type": "select",
                    "id": "condition",
                    "label": "Show if country code",
                    "options": [
                        {
                            "value": "equals",
                            "label": "Equals"
                        },
                        {
                            "value": "does_not_equal",
                            "label": "Does not equal"
                        }
                    ],
                    "default": "equals"
                },
                {
                    "type": "text",
                    "id": "code",
                    "label": "Country Code",
                    "default": "GB"
                },
                {
                    "type": "header",
                    "content": "Content"
                },
                {
                    "type": "textarea",
                    "id": "title",
                    "label": "Message"
                }
            ]
        },
        {
            "type": "continent_text",
            "name": "Continent Message",
            "settings": [
                {
                    "type": "header",
                    "content": "Display condition"
                },
                {
                    "type": "select",
                    "id": "condition",
                    "label": "Show if continent code",
                    "options": [
                        {
                            "value": "equals",
                            "label": "Equals"
                        },
                        {
                            "value": "does_not_equal",
                            "label": "Does not equal"
                        }
                    ],
                    "default": "equals"
                },
                {
                    "type": "text",
                    "id": "code",
                    "label": "Continent Code",
                    "default": "EU"
                },
                {
                    "type": "header",
                    "content": "Content"
                },
                {
                    "type": "textarea",
                    "id": "title",
                    "label": "Message"
                }
            ]
        }
    ],
    "settings": [
        {
            "type": "header",
            "content": "Details & Care"
        },
        {
            "type": "text",
            "id": "care_title",
            "label": "Title",
            "default": "Details & Care"
        },
        {
            "type": "richtext",
            "id": "care_text",
            "label": "Default Text",
            "default": "<p>Shell: 100% velvet. Hand wash only.</p>"
        },
        {
            "type": "header",
            "content": "Delivery & Returns"
        },
        {
            "type": "text",
            "id": "delivery_title",
            "label": "Title",
            "default": "Delivery & Returns"
        },
        {
            "type": "richtext",
            "id": "delivery_text",
            "label": "Text"
        },
        {
            "type": "header",
            "content": "Desktop padding"
        },
        {
            "type": "range",
            "id": "padding_top",
            "min": 0,
            "max": 128,
            "step": 2,
            "unit": "px",
            "label": "Padding top",
            "default": 32
        },
        {
            "type": "range",
            "id": "padding_bottom",
            "min": 0,
            "max": 128,
            "step": 2,
            "unit": "px",
            "label": "Padding bottom",
            "default": 64
        },
        {
            "type": "header",
            "content": "Mobile padding"
        },
        {
            "type": "range",
            "id": "mobile_padding_top",
            "min": 0,
            "max": 128,
            "step": 2,
            "unit": "px",
            "label": "Padding top",
            "default": 32
        },
        {
            "type": "range",
            "id": "mobile_padding_bottom",
            "min": 0,
            "max": 128,
            "step": 2,
            "unit": "px",
            "label": "Padding bottom",
            "default": 32
        }
    ]
}
{% endschema %}